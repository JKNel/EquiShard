{% extends 'base.html' %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Not Logged In State -->
    <div id="notLoggedIn" class="text-center py-5">
        <i class="bi bi-lock display-1 text-muted"></i>
        <h3 class="mt-3">Login Required</h3>
        <p class="text-muted">Please log in to view your portfolio dashboard</p>
        <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#loginModal">
            <i class="bi bi-box-arrow-in-right"></i> Login
        </button>
    </div>

    <!-- Dashboard Content (shown when logged in) -->
    <div id="dashboardContent" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-speedometer2 text-es-blue"></i> Dashboard</h2>
            <span class="text-muted">Welcome back, <strong id="welcomeUser">User</strong></span>
        </div>

        <!-- Portfolio Summary -->
        <div class="row g-4 mb-4">
            <div class="col-6 col-md-3">
                <div class="stat-card">
                    <div class="stat-label">Total Value</div>
                    <div class="stat-value" id="totalValue">$0.00</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="stat-card">
                    <div class="stat-label">Total Invested</div>
                    <div class="stat-value" id="totalInvested">$0.00</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="stat-card">
                    <div class="stat-label">Profit/Loss</div>
                    <div class="stat-value" id="profitLoss">$0.00</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="stat-card">
                    <div class="stat-label">Positions</div>
                    <div class="stat-value text-es-yellow" id="positionsCount">0</div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <!-- Portfolio Allocation -->
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header">
                        <i class="bi bi-pie-chart"></i> Portfolio Allocation
                    </div>
                    <div class="card-body">
                        <div id="allocationChart"></div>
                        <div id="allocationList" class="mt-3"></div>
                    </div>
                </div>
            </div>

            <!-- Positions -->
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header">
                        <i class="bi bi-wallet2"></i> Your Positions
                    </div>
                    <div class="card-body">
                        <div id="positionsList">
                            <div class="loading-spinner">
                                <div class="spinner-border text-primary" role="status"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-lightning"></i> Quick Actions
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <a href="/marketplace/" class="btn btn-primary w-100">
                                    <i class="bi bi-cart-plus"></i> Buy Assets
                                </a>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-warning w-100" onclick="useFaucet()">
                                    <i class="bi bi-droplet"></i> Add Funds (Faucet)
                                </button>
                            </div>
                            <div class="col-md-3">
                                <a href="/api/docs" class="btn btn-outline-primary w-100" target="_blank">
                                    <i class="bi bi-code-slash"></i> API Docs
                                </a>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-secondary w-100" onclick="loadDashboard()">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Check auth and show appropriate content
    function initDashboard() {
        const token = localStorage.getItem('access_token');
        const username = localStorage.getItem('username');

        if (token && username) {
            document.getElementById('notLoggedIn').style.display = 'none';
            document.getElementById('dashboardContent').style.display = 'block';
            document.getElementById('welcomeUser').textContent = username;
            loadDashboard();
        } else {
            document.getElementById('notLoggedIn').style.display = 'block';
            document.getElementById('dashboardContent').style.display = 'none';
        }
    }

    // Load dashboard data
    async function loadDashboard() {
        try {
            // Load portfolio summary
            const summary = await apiGet('/api/v1/analytics/summary');
            document.getElementById('totalValue').textContent = '$' + summary.total_value.toLocaleString();
            document.getElementById('totalInvested').textContent = '$' + summary.total_invested.toLocaleString();

            const plElement = document.getElementById('profitLoss');
            plElement.textContent = (summary.total_profit_loss >= 0 ? '+' : '') + '$' + summary.total_profit_loss.toLocaleString();
            plElement.className = 'stat-value ' + (summary.total_profit_loss >= 0 ? 'text-success' : 'text-danger');

            document.getElementById('positionsCount').textContent = summary.positions_count;

            // Load allocation
            const allocation = await apiGet('/api/v1/analytics/allocation');
            renderAllocation(allocation);

            // Load positions
            const positions = await apiGet('/api/v1/analytics/positions');
            renderPositions(positions);

        } catch (e) {
            console.error('Failed to load dashboard:', e);
            if (e.message.includes('401')) {
                showToast('Session expired. Please log in again.', 'error');
                logout();
            }
        }
    }

    // Render allocation chart
    function renderAllocation(data) {
        const container = document.getElementById('allocationList');

        if (data.length === 0) {
            container.innerHTML = '<div class="text-center text-muted py-3">No positions yet</div>';
            return;
        }

        const colors = ['#1e40af', '#3b82f6', '#f59e0b', '#fbbf24', '#10b981', '#8b5cf6'];
        container.innerHTML = data.map((item, i) => `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="d-flex align-items-center">
                    <span class="rounded-circle me-2" style="width: 12px; height: 12px; background: ${colors[i % colors.length]}"></span>
                    <span>${item.name}</span>
                </div>
                <div>
                    <span class="fw-bold">$${item.value.toLocaleString()}</span>
                    <span class="text-muted small ms-2">${item.percentage}%</span>
                </div>
            </div>
        `).join('');
    }

    // Render positions list
    function renderPositions(data) {
        const container = document.getElementById('positionsList');

        if (data.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="bi bi-inbox display-4"></i>
                    <p class="mt-2">No positions yet. Start investing!</p>
                    <a href="/marketplace/" class="btn btn-warning btn-sm">Browse Marketplace</a>
                </div>
            `;
            return;
        }

        container.innerHTML = data.map(pos => `
            <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                <div>
                    <div class="fw-bold">${pos.symbol}</div>
                    <div class="small text-muted">${pos.shares.toFixed(3)} shares @ $${pos.average_cost.toFixed(2)}</div>
                </div>
                <div class="d-flex align-items-center">
                    <div class="text-end me-3">
                        <div class="fw-bold">$${pos.current_value.toLocaleString()}</div>
                        <div class="small ${pos.profit_loss >= 0 ? 'text-success' : 'text-danger'}">
                            ${pos.profit_loss >= 0 ? '+' : ''}$${pos.profit_loss.toFixed(2)} (${pos.profit_loss_percent.toFixed(1)}%)
                        </div>
                    </div>
                    <a href="/asset/${pos.asset_id}/" class="btn btn-outline-primary btn-sm" title="View Details">
                        <i class="bi bi-arrow-right"></i>
                    </a>
                </div>
            </div>
        `).join('');
    }

    // Faucet to add funds
    async function useFaucet() {
        const token = localStorage.getItem('access_token');
        if (!token) {
            showToast('Please log in first', 'error');
            return;
        }

        try {
            const response = await fetch('/commands/ledger/faucet/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ amount: 1000, description: 'Dashboard faucet' })
            });

            if (!response.ok) throw new Error('Failed to add funds');

            const data = await response.json();
            showToast(`Added $1,000 to your wallet! New balance: $${data.new_balance}`, 'success');
            loadDashboard();
            updateBalance(); // Refresh header balance
        } catch (e) {
            showToast('Failed to add funds: ' + e.message, 'error');
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', initDashboard);
</script>
{% endblock %}